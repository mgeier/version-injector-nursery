# TODO: reference these in the docs:
#       https://github.com/orgs/community/discussions/7730
#       https://github.com/rossjrw/pr-preview-action
#       https://github.com/marketplace/actions/sticky-pull-request-comment
#       https://github.com/JamesIves/github-pages-deploy-action
#       https://github.com/blueedgetechno/win11React/blob/master/.github/workflows/pr-preview.yml

name: Build pull request preview
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

env:
  VERSION: ${{ github.event.number }}
  PAGES_STORAGE_REPO: mgeier/version-injector-nursery-pull-request-previews
jobs:
  build:
    uses: ./.github/workflows/build-docs.yml

  deploy-preview:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Check out storage repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PAGES_STORAGE_REPO }}
          token: ${{ secrets.PAGES_STORAGE_TOKEN }}
      - name: Remove target directory
        run: |
          rm -rf pages/$VERSION
      - uses: actions/download-artifact@v4
        with:
          name: docs
          path: pages/${{ env.VERSION }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3
      - name: Install version_injector
        # TODO: "normal" users should install the release from PyPI:
        run: |
          python -m pip install git+https://github.com/mgeier/version-injector-nursery.git@${{ github.ref }}
      - name: Inject PR warnings
        # TODO: implement this!
        run: |
          #python -m version_injector.generic_warning $VERSION
      - name: Set Git user/email
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      - name: Commit modified files
        # TODO: commit index.html?
        run: |
          git add pages/$VERSION
          git diff --cached --quiet || git commit -m "New/updated files for PR $VERSION"
      - name: Push commits
        run: |
          if ! git push
          then
            echo
            echo "Did another job run in parallel?"
            echo "If yes, please try re-running this job!"
            echo
            false
          fi
      # TODO: create/update PR comment
